# Azure Application Insights Infrastructure Overview

## Architecture Diagram

```
???????????????????????????????????????????????????????????????????
?                     Azure Subscription                          ?
?                                                                 ?
?  ????????????????????????????????????????????????????????????? ?
?  ?          Resource Group: rg-jaeger-demo                   ? ?
?  ?                                                           ? ?
?  ?  ???????????????????????????????????????????????????     ? ?
?  ?  ?     Log Analytics Workspace                     ?     ? ?
?  ?  ?     Name: log-xxxxxx                            ?     ? ?
?  ?  ?                                                 ?     ? ?
?  ?  ?  • Retention: 30 days                           ?     ? ?
?  ?  ?  • SKU: PerGB2018                               ?     ? ?
?  ?  ?  • Daily Quota: Unlimited (default)             ?     ? ?
?  ?  ???????????????????????????????????????????????????     ? ?
?  ?                          ?                                ? ?
?  ?                          ? Linked                         ? ?
?  ?                          ?                                ? ?
?  ?  ???????????????????????????????????????????????????     ? ?
?  ?  ?     Application Insights                        ?     ? ?
?  ?  ?     Name: appi-xxxxxx                           ?     ? ?
?  ?  ?                                                 ?     ? ?
?  ?  ?  • Type: web                                    ?     ? ?
?  ?  ?  • Retention: 90 days                           ?     ? ?
?  ?  ?  • Sampling: 100%                               ?     ? ?
?  ?  ?  • Connection String: InstrumentationKey=...    ?     ? ?
?  ?  ???????????????????????????????????????????????????     ? ?
?  ?                          ?                                ? ?
?  ????????????????????????????????????????????????????????????? ?
?                             ?                                  ?
??????????????????????????????????????????????????????????????????
                              ?
                              ? OpenTelemetry
                              ? Telemetry Export
                              ?
                    ?????????????????????
                    ?                   ?
            ?????????????????   ?????????????????
            ?   Local Dev   ?   ?  Production   ?
            ?  Environment  ?   ?  Environment  ?
            ?               ?   ?               ?
            ? .NET 9 App    ?   ? .NET 9 App    ?
            ?               ?   ?               ?
            ? ????????????  ?   ? ????????????  ?
            ? ?OpenTelem ?  ?   ? ?OpenTelem ?  ?
            ? ?  + Azure ?  ?   ? ?  + Azure ?  ?
            ? ? Monitor  ?  ?   ? ? Monitor  ?  ?
            ? ????????????  ?   ? ????????????  ?
            ?      ?        ?   ?      ?        ?
            ?      ? Also   ?   ?      ?        ?
            ?      ? sends  ?   ?      ?        ?
            ? ????????????  ?   ?      ?        ?
            ? ?  Jaeger  ?  ?   ?      ?        ?
            ? ? (local)  ?  ?   ?      ?        ?
            ? ????????????  ?   ?      ?        ?
            ?????????????????   ?????????????????
```

## Deployment Flow

```
????????????????????
?   Developer      ?
?   Workstation    ?
????????????????????
         ?
         ? 1. Run deploy script
         ?
????????????????????????????????????????????
?   Azure Developer CLI (azd)              ?
?                                          ?
?  • Auth login                            ?
?  • Environment setup                     ?
?  • Parameter configuration               ?
????????????????????????????????????????????
         ?
         ? 2. Execute Bicep templates
         ?
????????????????????????????????????????????
?   Azure Resource Manager (ARM)           ?
?                                          ?
?  • Validate templates                    ?
?  • Create resource group                 ?
?  • Deploy resources                      ?
????????????????????????????????????????????
         ?
         ? 3. Resources created
         ?
????????????????????????????????????????????
?   Azure Resources                        ?
?                                          ?
?  ? Resource Group                        ?
?  ? Log Analytics Workspace               ?
?  ? Application Insights                  ?
????????????????????????????????????????????
         ?
         ? 4. Return outputs
         ?
????????????????????????????????????????????
?   Connection String & Config             ?
?                                          ?
?  • APPLICATIONINSIGHTS_CONNECTION_STRING ?
?  • APPLICATIONINSIGHTS_NAME              ?
?  • AZURE_RESOURCE_GROUP                  ?
????????????????????????????????????????????
         ?
         ? 5. Update configuration
         ?
????????????????????????????????????????????
?   appsettings.json (optional)            ?
?                                          ?
?  {                                       ?
?    "ConnectionStrings": {                ?
?      "ApplicationInsights": "..."        ?
?    }                                     ?
?  }                                       ?
????????????????????????????????????????????
```

## File Structure

```
JaegerGettingStarted/
?
??? infra/                                 # Infrastructure as Code
?   ??? .gitignore                         # Git ignore for infra files
?   ?
?   ??? AzureAppInsight/                   # Azure App Insights module
?       ??? main.bicep                     # Main infrastructure template
?       ??? main.parameters.json           # Parameter bindings
?       ??? abbreviations.json             # Azure naming conventions
?       ??? .env.template                  # Environment variables template
?       ??? README.md                      # Detailed deployment guide
?       ??? QUICK_REFERENCE.md             # Quick command reference
?       ??? deploy.ps1                     # PowerShell deployment script
?       ??? deploy.sh                      # Bash deployment script
?       ?
?       ??? modules/                       # Bicep modules
?           ??? log-analytics.bicep        # Log Analytics workspace
?           ??? application-insights.bicep # Application Insights resource
?
??? azure.yaml                             # azd configuration
??? .azdignore                             # azd ignore patterns
?
??? JaegerDemo.Api.csproj                  # .NET project
??? Program.cs                             # Application entry point
??? appsettings.json                       # App configuration
??? Help/                                  # Documentation
    ??? AZURE_APPLICATION_INSIGHTS_INTEGRATION.md
```

## Resource Naming Convention

Azure resources follow Microsoft's recommended abbreviations:

| Resource Type | Abbreviation | Example |
|---------------|--------------|---------|
| Resource Group | `rg-` | `rg-jaeger-demo` |
| Log Analytics Workspace | `log-` | `log-abc123` |
| Application Insights | `appi-` | `appi-abc123` |

The `abc123` suffix is a unique hash generated from:
- Subscription ID
- Environment name
- Location

## Cost Breakdown

### Free Tier (First 5 GB/month)
```
??????????????????????????????????????????
? Application Insights                   ?
? ??? Data Ingestion: 5 GB      $0.00   ?
? ??? Data Retention: 90 days   $0.00   ?
? ??? Basic Queries              $0.00   ?
??????????????????????????????????????????
? Log Analytics Workspace                ?
? ??? Data Ingestion: 5 GB      $0.00   ?
? ??? Data Retention: 30 days   $0.00   ?
? ??? Basic Queries              $0.00   ?
??????????????????????????????????????????
? TOTAL (Typical Dev Usage)     $0.00   ?
??????????????????????????????????????????
```

### Beyond Free Tier
```
??????????????????????????????????????????
? Per GB Pricing (over 5 GB)             ?
? ??? Data Ingestion         $2.30/GB   ?
? ??? Extended Retention     $0.10/GB    ?
? ??? Data Archive           $0.02/GB    ?
??????????????????????????????????????????
```

### Estimated Monthly Costs by Usage

| Daily Ingestion | Monthly Total | Estimated Cost |
|-----------------|---------------|----------------|
| 100 MB | ~3 GB | $0 (Free tier) |
| 200 MB | ~6 GB | ~$2.30 |
| 500 MB | ~15 GB | ~$23.00 |
| 1 GB | ~30 GB | ~$57.50 |
| 5 GB | ~150 GB | ~$333.50 |

## Telemetry Flow

```
???????????????????????????????????????????????????????????????
?  .NET Application                                           ?
?  ????????????????????????????????????????????????????????   ?
?  ?  OpenTelemetry SDK                                   ?   ?
?  ?                                                      ?   ?
?  ?  ??????????????????????????????????????????????     ?   ?
?  ?  ?  Instrumentation Libraries                 ?     ?   ?
?  ?  ?  • ASP.NET Core                            ?     ?   ?
?  ?  ?  • HttpClient                              ?     ?   ?
?  ?  ?  • Entity Framework Core                   ?     ?   ?
?  ?  ?  • Custom ActivitySource                   ?     ?   ?
?  ?  ??????????????????????????????????????????????     ?   ?
?  ?                     ?                                ?   ?
?  ?                     ?                                ?   ?
?  ?  ??????????????????????????????????????????????     ?   ?
?  ?  ?  Telemetry Data (in-memory)                ?     ?   ?
?  ?  ?  • Traces                                  ?     ?   ?
?  ?  ?  • Spans                                   ?     ?   ?
?  ?  ?  • Attributes/Tags                         ?     ?   ?
?  ?  ?  • Exceptions                              ?     ?   ?
?  ?  ??????????????????????????????????????????????     ?   ?
?  ?                     ?                                ?   ?
?  ?                     ?                                ?   ?
?  ?  ??????????????????????????????????????????????     ?   ?
?  ?  ?  Exporters                                 ?     ?   ?
?  ?  ?  • Azure Monitor Exporter ???????????????  ?     ?   ?
?  ?  ?  • OTLP Exporter (Jaeger) ???????????   ?  ?     ?   ?
?  ?  ?  • Console Exporter                 ?   ?  ?     ?   ?
?  ?  ???????????????????????????????????????????????     ?   ?
?  ????????????????????????????????????????????????????????   ?
???????????????????????????????????????????????????????????????
                                             ?   ?
                        ??????????????????????   ??????????????
                        ?                                     ?
                        ?                                     ?
          ????????????????????????              ????????????????????????
          ?  Jaeger (Local)      ?              ?  Azure Application   ?
          ?  • Instant feedback  ?              ?  Insights            ?
          ?  • Development       ?              ?  • Cloud storage     ?
          ?  • Port 4317 (gRPC) ?              ?  • Production        ?
          ?  • UI: :16686        ?              ?  • Analytics         ?
          ????????????????????????              ?  • Alerting          ?
                                                ?  • Smart Detection   ?
                                                ????????????????????????
```

## Security & Best Practices

### Connection String Management

| Environment | Storage Method | Priority |
|-------------|---------------|----------|
| **Local Development** | User Secrets | 1st (Recommended) |
| **Local Development** | appsettings.Development.json | 2nd |
| **CI/CD Pipeline** | Pipeline Secrets/Variables | 1st |
| **Azure App Service** | App Configuration | 1st |
| **Azure Container Apps** | Secret Store | 1st |
| **Azure Kubernetes** | Kubernetes Secrets | 1st |

### ? Never Do This
```json
// appsettings.json (committed to Git)
{
  "ConnectionStrings": {
    "ApplicationInsights": "InstrumentationKey=real-key-here..."
  }
}
```

### ? Do This Instead
```bash
# Use dotnet user-secrets
dotnet user-secrets set "ConnectionStrings:ApplicationInsights" "your-connection-string"

# Or environment variable
export APPLICATIONINSIGHTS_CONNECTION_STRING="your-connection-string"

# Azure App Service Application Settings
# Set in Azure Portal ? Configuration ? Application Settings
```

## Monitoring Capabilities

### What You Can See in Application Insights

#### 1. Application Map
```
???????????????      ???????????????      ???????????????
?  Frontend   ????????  Your API   ????????   SQL DB    ?
?  (Browser)  ?      ?             ?      ?             ?
???????????????      ???????????????      ???????????????
     500 req/min       Response: 120ms      Query: 45ms
     5 errors          Success: 99%         Success: 100%
```

#### 2. Transaction Search
- View individual requests with full trace details
- See all spans in a request
- Exception details with stack traces
- Database queries executed
- Response times for each operation

#### 3. Performance View
- Response time distribution
- Slowest operations
- Dependency performance (database, HTTP calls)
- Operation count over time

#### 4. Failures View
- Exception count and trends
- Failed request details
- Error rate by operation
- Affected users (if user tracking enabled)

#### 5. Live Metrics
- Real-time request rate
- Real-time response time
- Real-time exception rate
- Server metrics (CPU, memory)

## Comparison Matrix

| Feature | Jaeger (Local) | Azure App Insights |
|---------|----------------|-------------------|
| **Setup Time** | 2 minutes | 5-10 minutes |
| **Cost** | Free | Free tier + paid |
| **Data Retention** | Limited by disk | 90 days default |
| **Query Language** | Basic search | KQL (powerful) |
| **Alerting** | None | Built-in |
| **Smart Detection** | None | AI-powered |
| **Live Metrics** | None | Yes |
| **Production Ready** | No | Yes |
| **Learning Curve** | Easy | Medium |
| **Integration** | OpenTelemetry | Azure ecosystem |
| **Best For** | Development | Production |

## Troubleshooting Decision Tree

```
??????????????????????????????????????
?  No data in Application Insights? ?
??????????????????????????????????????
                ?
                ?
    ?????????????????????????????
    ? Check connection string?  ?
    ?????????????????????????????
        ? Correct           ? Wrong
        ?                   ?
    ??????????????      ????????????????
    ? Data after ?      ? Update from  ?
    ? 3 minutes? ?      ? azd outputs  ?
    ??????????????      ????????????????
      ? Yes    ? No
      ?        ?
    ??????  ???????????????????
    ? OK ?  ? Check firewall? ?
    ??????  ???????????????????
              ? OK        ? Blocked
              ?           ?
          ??????????  ????????????????
          ? Check  ?  ? Allow HTTPS  ?
          ? region ?  ? to Azure     ?
          ??????????  ????????????????
```

## Next Steps After Deployment

1. ? **Verify deployment** - Check Azure Portal
2. ? **Test locally** - Run app and make requests
3. ? **View in Jaeger** - Immediate feedback (localhost:16686)
4. ? **Wait 2-3 minutes** - Azure ingestion delay
5. ? **View in Azure Portal** - Check Application Insights
6. ?? **Set up alerts** - Critical failures, high latency
7. ?? **Create dashboards** - Custom views for your team
8. ?? **Secure connection string** - Use Key Vault or App Configuration
9. ?? **Enable sampling** - For high-volume production apps
10. ?? **Deploy to production** - Use same infrastructure in prod environment

---

**?? Pro Tip**: Start with Jaeger for learning and development, then add Application Insights when you're ready for production monitoring!
